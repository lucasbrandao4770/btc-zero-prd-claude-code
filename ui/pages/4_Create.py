"""Create Page - Create new PROMPT files.

This page provides:
- Form for creating new PROMPT files
- Input validation
- Dynamic task input
- Preview before save
"""

from __future__ import annotations

import re
from datetime import datetime

import streamlit as st

from ui.config import QUALITY_TIERS, get_tasks_path
from ui.state import (
    init_session_state,
    set_selected_file,
)

# Initialize session state
init_session_state()

# Page config
st.set_page_config(page_title="Create - Dev Loop UI", page_icon="heavy_plus_sign", layout="wide")


# =============================================================================
# Validation Functions
# =============================================================================


def validate_name(name: str) -> tuple[bool, str]:
    """Validate PROMPT name.

    Args:
        name: The proposed name

    Returns:
        Tuple of (is_valid, error_message)
    """
    if not name:
        return False, "Name is required"

    if len(name) < 2:
        return False, "Name must be at least 2 characters"

    if len(name) > 50:
        return False, "Name must be 50 characters or less"

    # Only alphanumeric and underscore
    if not re.match(r"^[A-Za-z0-9_]+$", name):
        return False, "Name can only contain letters, numbers, and underscores"

    # Check if file already exists
    target_path = get_tasks_path() / f"PROMPT_{name.upper()}.md"
    if target_path.exists():
        return False, f"A PROMPT named '{name}' already exists"

    return True, ""


def validate_goal(goal: str) -> tuple[bool, str]:
    """Validate goal statement.

    Args:
        goal: The goal text

    Returns:
        Tuple of (is_valid, error_message)
    """
    if not goal:
        return False, "Goal is required"

    if len(goal) < 10:
        return False, "Goal must be at least 10 characters"

    return True, ""


def sanitize_name(name: str) -> str:
    """Sanitize name to prevent path traversal.

    Args:
        name: Raw name input

    Returns:
        Sanitized name
    """
    # Remove any path separators
    name = name.replace("/", "_").replace("\\", "_").replace("..", "_")
    # Remove non-alphanumeric except underscore
    name = re.sub(r"[^A-Za-z0-9_]", "", name)
    return name.upper()


# =============================================================================
# Template Generation
# =============================================================================


def generate_prompt_template(
    name: str,
    goal: str,
    tier: str,
    tasks: list[dict],
    exit_criteria: list[str],
) -> str:
    """Generate PROMPT markdown content.

    Args:
        name: PROMPT name
        goal: Goal statement
        tier: Quality tier
        tasks: List of task dicts with 'description' and 'priority'
        exit_criteria: List of exit criterion descriptions

    Returns:
        Markdown content for the PROMPT file
    """
    # Group tasks by priority
    risky_tasks = [t for t in tasks if t.get("priority") == "RISKY"]
    core_tasks = [t for t in tasks if t.get("priority") == "CORE"]
    polish_tasks = [t for t in tasks if t.get("priority") == "POLISH"]

    # Build tasks section
    tasks_section = "## Tasks (Prioritized)\n\n"

    if risky_tasks:
        tasks_section += "### RISKY (Do First)\n\n"
        for t in risky_tasks:
            tasks_section += f"- [ ] {t['description']}\n"
        tasks_section += "\n"

    if core_tasks:
        tasks_section += "### CORE\n\n"
        for t in core_tasks:
            tasks_section += f"- [ ] {t['description']}\n"
        tasks_section += "\n"

    if polish_tasks:
        tasks_section += "### POLISH (Do Last)\n\n"
        for t in polish_tasks:
            tasks_section += f"- [ ] {t['description']}\n"
        tasks_section += "\n"

    # Build exit criteria section
    exit_section = "## Exit Criteria\n\n"
    for criterion in exit_criteria:
        if criterion.strip():
            exit_section += f"- [ ] {criterion}\n"

    # Generate full template
    template = f"""# PROMPT: {name}

> Generated by Dev Loop UI

---

## Goal

{goal}

---

## Quality Tier

**Tier:** {tier}

---

{tasks_section}
---

{exit_section}
---

## Progress

**Status:** NOT_STARTED

---

## Config

```yaml
mode: hitl
quality_tier: {tier}
max_iterations: 30
max_retries: 3
circuit_breaker: 3
small_steps: true
```

---

*Generated by Dev Loop UI on {datetime.now().strftime('%Y-%m-%d %H:%M')}*
"""

    return template


# =============================================================================
# Main Content
# =============================================================================

st.title("Create New PROMPT")

st.markdown("""
Create a new Dev Loop PROMPT file by filling out the form below.
All fields marked with * are required.
""")

# Initialize task list in session state
if "create_tasks" not in st.session_state:
    st.session_state.create_tasks = [{"description": "", "priority": "CORE"}]

if "create_exit_criteria" not in st.session_state:
    st.session_state.create_exit_criteria = [""]


# Form
with st.form("create_prompt_form"):
    # Name input
    col1, col2 = st.columns([2, 1])
    with col1:
        name = st.text_input(
            "Name *",
            placeholder="MY_FEATURE",
            help="Alphanumeric and underscores only. Will be uppercased.",
        )
    with col2:
        if name:
            sanitized = sanitize_name(name)
            st.caption(f"File: PROMPT_{sanitized}.md")

    # Goal input
    goal = st.text_area(
        "Goal *",
        placeholder="Describe what this PROMPT will accomplish...",
        help="Minimum 10 characters",
        height=100,
    )

    # Quality tier
    tier = st.selectbox(
        "Quality Tier *",
        options=QUALITY_TIERS,
        index=1,  # Default to 'production'
        help="prototype: speed over perfection | production: tests required | library: full docs",
    )

    st.divider()

    # Tasks section
    st.subheader("Tasks")
    st.caption("Add tasks with their priority level")

    # Dynamic task inputs
    tasks = []
    for i, task in enumerate(st.session_state.create_tasks):
        col1, col2 = st.columns([3, 1])
        with col1:
            desc = st.text_input(
                f"Task {i + 1}",
                value=task.get("description", ""),
                key=f"task_desc_{i}",
                placeholder="Describe the task...",
                label_visibility="collapsed",
            )
        with col2:
            priority = st.selectbox(
                f"Priority {i + 1}",
                options=["RISKY", "CORE", "POLISH"],
                index=["RISKY", "CORE", "POLISH"].index(task.get("priority", "CORE")),
                key=f"task_priority_{i}",
                label_visibility="collapsed",
            )
        if desc:
            tasks.append({"description": desc, "priority": priority})

    st.divider()

    # Exit criteria section
    st.subheader("Exit Criteria")
    st.caption("Define conditions that must be met for the PROMPT to be complete")

    exit_criteria = []
    for i, criterion in enumerate(st.session_state.create_exit_criteria):
        ec = st.text_input(
            f"Criterion {i + 1}",
            value=criterion,
            key=f"exit_criterion_{i}",
            placeholder="e.g., All tests pass: `pytest tests/ -v`",
            label_visibility="collapsed",
        )
        if ec:
            exit_criteria.append(ec)

    st.divider()

    # Submit button
    submitted = st.form_submit_button("Create PROMPT", use_container_width=True)


# Handle form submission
if submitted:
    # Validate inputs
    name_valid, name_error = validate_name(sanitize_name(name) if name else "")
    goal_valid, goal_error = validate_goal(goal)

    errors = []
    if not name_valid:
        errors.append(f"**Name:** {name_error}")
    if not goal_valid:
        errors.append(f"**Goal:** {goal_error}")
    if not tasks:
        errors.append("**Tasks:** At least one task is required")
    if not exit_criteria:
        errors.append("**Exit Criteria:** At least one criterion is required")

    if errors:
        st.error("Please fix the following errors:")
        for error in errors:
            st.markdown(f"- {error}")
    else:
        # Generate content
        sanitized_name = sanitize_name(name)
        content = generate_prompt_template(
            name=sanitized_name,
            goal=goal,
            tier=tier,
            tasks=tasks,
            exit_criteria=exit_criteria,
        )

        # Save file
        target_path = get_tasks_path() / f"PROMPT_{sanitized_name}.md"

        try:
            # Ensure directory exists
            target_path.parent.mkdir(parents=True, exist_ok=True)

            # Write file
            target_path.write_text(content, encoding="utf-8")

            st.success(f"Created PROMPT_{sanitized_name}.md successfully!")

            # Clear cache and show link
            st.cache_data.clear()

            col1, col2 = st.columns([1, 1])
            with col1:
                if st.button("View Created PROMPT"):
                    set_selected_file(target_path, "prompt")
                    st.switch_page("pages/1_Tasks.py")
            with col2:
                if st.button("Create Another"):
                    # Reset form state
                    st.session_state.create_tasks = [{"description": "", "priority": "CORE"}]
                    st.session_state.create_exit_criteria = [""]
                    st.rerun()

        except Exception as e:
            st.error(f"Failed to create file: {e}")


# Add/remove task buttons (outside form)
st.divider()
col1, col2 = st.columns([1, 1])
with col1:
    if st.button("+ Add Task"):
        st.session_state.create_tasks.append({"description": "", "priority": "CORE"})
        st.rerun()
with col2:
    if len(st.session_state.create_tasks) > 1:
        if st.button("- Remove Last Task"):
            st.session_state.create_tasks.pop()
            st.rerun()

col1, col2 = st.columns([1, 1])
with col1:
    if st.button("+ Add Exit Criterion"):
        st.session_state.create_exit_criteria.append("")
        st.rerun()
with col2:
    if len(st.session_state.create_exit_criteria) > 1:
        if st.button("- Remove Last Criterion"):
            st.session_state.create_exit_criteria.pop()
            st.rerun()


# Preview section
st.divider()
st.subheader("Preview")

if name and goal:
    sanitized_name = sanitize_name(name)
    preview_tasks = []
    for i in range(len(st.session_state.create_tasks)):
        desc = st.session_state.get(f"task_desc_{i}", "")
        priority = st.session_state.get(f"task_priority_{i}", "CORE")
        if desc:
            preview_tasks.append({"description": desc, "priority": priority})

    preview_criteria = []
    for i in range(len(st.session_state.create_exit_criteria)):
        ec = st.session_state.get(f"exit_criterion_{i}", "")
        if ec:
            preview_criteria.append(ec)

    preview_content = generate_prompt_template(
        name=sanitized_name,
        goal=goal,
        tier=tier,
        tasks=preview_tasks or [{"description": "(no tasks)", "priority": "CORE"}],
        exit_criteria=preview_criteria or ["(no criteria)"],
    )

    with st.expander("Show Generated Markdown", expanded=False):
        st.code(preview_content, language="markdown")
else:
    st.info("Fill in the Name and Goal fields to see a preview.")
